// pages/AddTask.ets
import router from '@ohos.router'
import preferences from '@ohos.data.preferences'

// ä»»åŠ¡æ•°æ®æ¥å£
interface TaskItem {
  id: number
  title: string
  content: string
  completed: boolean
  createdAt: string
  reminderTime?: string
}

@Entry
@Component
struct AddTaskPage {
  @State title: string = ''
  @State content: string = ''
  @State reminderTime: string = ''
  @State showDatePicker: boolean = false
  @State showTimePicker: boolean = false
  @State selectedDate: Date = new Date()
  @State selectedHour: number = 9
  @State selectedMinute: number = 0
  @State selectedAmPm: string = 'AM'
  @State isLoading: boolean = false

  // ç”Ÿæˆæ–°çš„ä»»åŠ¡ID
  generateNewId(): number {
    return Date.now()
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´æ˜¾ç¤º
  formatDateTime(date: Date): string {
    const year = date.getFullYear()
    const month = (date.getMonth() + 1).toString().padStart(2, '0')
    const day = date.getDate().toString().padStart(2, '0')
    const hours = date.getHours().toString().padStart(2, '0')
    const minutes = date.getMinutes().toString().padStart(2, '0')

    return `${year}-${month}-${day} ${hours}:${minutes}`
  }

  // è®¾ç½®æé†’æ—¶é—´
  setReminderTime() {
    // è½¬æ¢12å°æ—¶åˆ¶åˆ°24å°æ—¶åˆ¶
    let hour24 = this.selectedHour
    if (this.selectedAmPm === 'PM' && this.selectedHour !== 12) {
      hour24 = this.selectedHour + 12
    } else if (this.selectedAmPm === 'AM' && this.selectedHour === 12) {
      hour24 = 0
    }

    const combinedDateTime = new Date(
      this.selectedDate.getFullYear(),
      this.selectedDate.getMonth(),
      this.selectedDate.getDate(),
      hour24,
      this.selectedMinute
    )
    this.reminderTime = this.formatDateTime(combinedDateTime)
  }

  // æ¸…é™¤æé†’æ—¶é—´
  clearReminderTime() {
    this.reminderTime = ''
  }

  // è·å–å½“å‰æ—¶é—´æ˜¾ç¤ºæ–‡æœ¬
  getCurrentTimeDisplay(): string {
    // è½¬æ¢ä¸º24å°æ—¶åˆ¶æ˜¾ç¤º
    let hour24 = this.selectedHour
    if (this.selectedAmPm === 'PM' && this.selectedHour !== 12) {
      hour24 = this.selectedHour + 12
    } else if (this.selectedAmPm === 'AM' && this.selectedHour === 12) {
      hour24 = 0
    }
    return `${hour24.toString().padStart(2, '0')}:${this.selectedMinute.toString().padStart(2, '0')}`
  }

  // ä¿å­˜ä»»åŠ¡
  async saveTask() {
    // éªŒè¯è¾“å…¥
    if (!this.title.trim()) {
      console.log('ä»»åŠ¡æ ‡é¢˜ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜')
      return
    }

    this.isLoading = true
    console.log('å¼€å§‹ä¿å­˜ä»»åŠ¡...')

    try {
      // åˆ›å»ºæ–°ä»»åŠ¡
      const newTask: TaskItem = {
        id: this.generateNewId(),
        title: this.title.trim(),
        content: this.content.trim(),
        completed: false,
        createdAt: this.formatDateTime(new Date()),
        reminderTime: this.reminderTime || undefined
      }

      console.log('æ–°ä»»åŠ¡æ•°æ®:', newTask)

      // ä»æœ¬åœ°å­˜å‚¨è¯»å–ç°æœ‰ä»»åŠ¡
      const context = getContext(this)
      const dataPreferences = await preferences.getPreferences(context, 'todoApp')
      const tasksData = await dataPreferences.get('tasks', '[]')

      let tasks: TaskItem[] = []
      if (typeof tasksData === 'string') {
        tasks = JSON.parse(tasksData)
      }

      // æ·»åŠ æ–°ä»»åŠ¡
      tasks.push(newTask)
      console.log('ä»»åŠ¡åˆ—è¡¨æ›´æ–°å:', tasks.length, 'ä¸ªä»»åŠ¡')

      // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      await dataPreferences.put('tasks', JSON.stringify(tasks))
      await dataPreferences.flush()
      console.log('ä»»åŠ¡ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡è¿”å›é¦–é¡µ')

      // çŸ­æš‚å»¶æ—¶åè·³è½¬
      setTimeout(() => {
        // è¿”å›é¦–é¡µ - å°è¯•å¤šç§æ–¹æ³•
        try {
          // æ–¹æ³•1ï¼šä½¿ç”¨ replaceUrl
          router.replaceUrl({
            url: 'pages/Index'
          }).then(() => {
            console.log('ä½¿ç”¨ replaceUrl è·³è½¬æˆåŠŸ')
          }).catch((error) => {
            console.log('replaceUrl å¤±è´¥:', error)
            // æ–¹æ³•2ï¼šä½¿ç”¨ back
            router.back()
            console.log('fallback åˆ° router.back()')
          })
        } catch (error) {
          console.log('è·³è½¬å¼‚å¸¸:', error)
          router.back()
        }
      }, 100)
    } catch (error) {
      console.error('ä¿å­˜ä»»åŠ¡å¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  // å–æ¶ˆæ“ä½œ
  cancelAdd() {
    router.back()
  }

  build() {
    Stack() {
      // ä¸»ç•Œé¢
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Text('å–æ¶ˆ')
            .fontSize(16)
            .fontColor('#2563eb')
            .onClick(() => {
              this.cancelAdd()
            })

          Blank()

          Text('æ·»åŠ ä»»åŠ¡')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1f2937')

          Blank()

          Text(this.isLoading ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜')
            .fontSize(16)
            .fontColor(this.title.trim() ? '#2563eb' : '#9ca3af')
            .onClick(() => {
              if (!this.isLoading && this.title.trim()) {
                this.saveTask()
              }
            })
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .backgroundColor('#ffffff')
        .border({ width: { bottom: 1 }, color: '#e5e7eb' })

        // ä¸»è¦å†…å®¹åŒºåŸŸ
        Column() {
          // ä»»åŠ¡æ ‡é¢˜è¾“å…¥
          Column() {
            Text('ä»»åŠ¡æ ‡é¢˜ *')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#374151')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })

            TextInput({ placeholder: 'è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜' })
              .fontSize(16)
              .fontColor('#1f2937')
              .backgroundColor('#f9fafb')
              .border({ width: 1, color: '#d1d5db', radius: 8 })
              .height(48)
              .onChange((value: string) => {
                this.title = value
              })
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
          .margin({ bottom: 24 })

          // ä»»åŠ¡å†…å®¹è¾“å…¥
          Column() {
            Text('ä»»åŠ¡å†…å®¹')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#374151')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })

            TextArea({ placeholder: 'è¯·è¾“å…¥ä»»åŠ¡çš„è¯¦ç»†æè¿°...' })
              .fontSize(16)
              .fontColor('#1f2937')
              .backgroundColor('#f9fafb')
              .border({ width: 1, color: '#d1d5db', radius: 8 })
              .height(120)
              .onChange((value: string) => {
                this.content = value
              })
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
          .margin({ bottom: 24 })

          // æé†’æ—¶é—´è®¾ç½®
          Column() {
            Row() {
              Text('æé†’æ—¶é—´')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#374151')

              Blank()

              if (this.reminderTime) {
                Text('æ¸…é™¤')
                  .fontSize(14)
                  .fontColor('#ef4444')
                  .onClick(() => {
                    this.clearReminderTime()
                  })
              }
            }
            .width('100%')
            .margin({ bottom: 12 })

            // æé†’æ—¶é—´æ˜¾ç¤º/è®¾ç½®åŒºåŸŸ
            if (this.reminderTime) {
              // å·²è®¾ç½®æé†’æ—¶é—´
              Button() {
                Row() {
                  Text('ğŸ“…')
                    .fontSize(20)
                    .margin({ right: 12 })

                  Column() {
                    Text(this.reminderTime)
                      .fontSize(16)
                      .fontColor('#1f2937')
                      .fontWeight(FontWeight.Medium)
                    Text('ç‚¹å‡»ä¿®æ”¹æé†’æ—¶é—´')
                      .fontSize(12)
                      .fontColor('#6b7280')
                      .margin({ top: 2 })
                  }
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)

                  Text('>')
                    .fontSize(16)
                    .fontColor('#9ca3af')
                }
                .width('100%')
                .justifyContent(FlexAlign.Start)
              }
              .width('100%')
              .height(70)
              .padding(16)
              .backgroundColor('#f0f9ff')
              .borderRadius(8)
              .border({ width: 1, color: '#bae6fd' })
              .onClick(() => {
                this.showDatePicker = true
              })
            } else {
              // æœªè®¾ç½®æé†’æ—¶é—´
              Button() {
                Row() {
                  Text('â°')
                    .fontSize(18)
                    .margin({ right: 12 })

                  Text('è®¾ç½®æé†’æ—¶é—´')
                    .fontSize(16)
                    .fontColor('#6b7280')
                    .layoutWeight(1)

                  Text('+')
                    .fontSize(20)
                    .fontColor('#2563eb')
                }
                .width('100%')
                .justifyContent(FlexAlign.Start)
              }
              .width('100%')
              .height(56)
              .backgroundColor('#ffffff')
              .borderRadius(8)
              .border({ width: 1, color: '#d1d5db', style: BorderStyle.Dashed })
              .onClick(() => {
                console.log('ç‚¹å‡»è®¾ç½®æé†’æ—¶é—´')
                this.showDatePicker = true
              })
            }
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
          .margin({ bottom: 32 })

          // æç¤ºä¿¡æ¯
          Text('* ä»»åŠ¡æ ‡é¢˜ä¸ºå¿…å¡«é¡¹')
            .fontSize(12)
            .fontColor('#9ca3af')
            .alignSelf(ItemAlign.Start)
        }
        .width('100%')
        .layoutWeight(1)
        .padding(16)
        .backgroundColor('#ffffff')
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f9fafb')

      // æ—¥æœŸé€‰æ‹©å™¨
      if (this.showDatePicker) {
        Column() {
          // é®ç½©å±‚
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('#00000080')
            .onClick(() => {
              console.log('ç‚¹å‡»é®ç½©å±‚ï¼Œå…³é—­æ—¥æœŸé€‰æ‹©å™¨')
              this.showDatePicker = false
            })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)

        // æ—¥æœŸé€‰æ‹©å™¨å¼¹çª—
        Column() {
          Text('é€‰æ‹©æ—¥æœŸ')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1f2937')
            .margin({ bottom: 16 })

          DatePicker({
            start: new Date(),
            end: new Date(2030, 11, 31),
            selected: this.selectedDate
          })
            .onChange((value: DatePickerResult) => {
              console.log('é€‰æ‹©æ—¥æœŸ:', value.year, value.month, value.day)
              this.selectedDate = new Date(value.year, value.month, value.day)
            })

          Row() {
            Button('å–æ¶ˆ')
              .fontSize(16)
              .fontColor('#6b7280')
              .backgroundColor('#f3f4f6')
              .width('40%')
              .onClick(() => {
                console.log('å–æ¶ˆé€‰æ‹©æ—¥æœŸ')
                this.showDatePicker = false
              })

            Button('ç¡®å®š')
              .fontSize(16)
              .fontColor('#ffffff')
              .backgroundColor('#2563eb')
              .width('40%')
              .onClick(() => {
                console.log('ç¡®å®šé€‰æ‹©æ—¥æœŸï¼Œæ‰“å¼€æ—¶é—´é€‰æ‹©å™¨')
                this.showDatePicker = false
                this.showTimePicker = true
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceAround)
          .margin({ top: 24 })
        }
        .width('80%')
        .padding(20)
        .backgroundColor('#ffffff')
        .borderRadius(12)
        .position({ x: '10%', y: '35%' })
      }

      // æ—¶é—´é€‰æ‹©å™¨
      if (this.showTimePicker) {
        Column() {
          // é®ç½©å±‚
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('#00000080')
            .onClick(() => {
              console.log('ç‚¹å‡»é®ç½©å±‚ï¼Œå…³é—­æ—¶é—´é€‰æ‹©å™¨')
              this.showTimePicker = false
            })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)

        // æ—¶é—´é€‰æ‹©å™¨å¼¹çª—
        Column() {
          Text('é€‰æ‹©æ—¶é—´')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1f2937')
            .margin({ bottom: 16 })

          // è‡ªå®šä¹‰æ—¶é—´é€‰æ‹©å™¨
          Row() {
            // å°æ—¶é€‰æ‹©
            Column() {
              Text('å°æ—¶')
                .fontSize(14)
                .fontColor('#6b7280')
                .margin({ bottom: 8 })

              List() {
                ForEach([1,2,3,4,5,6,7,8,9,10,11,12], (hour: number) => {
                  ListItem() {
                    Text(hour.toString())
                      .fontSize(16)
                      .fontColor(this.selectedHour === hour ? '#ffffff' : '#1f2937')
                      .fontWeight(this.selectedHour === hour ? FontWeight.Bold : FontWeight.Normal)
                      .width(40)
                      .height(32)
                      .textAlign(TextAlign.Center)
                      .backgroundColor(this.selectedHour === hour ? '#2563eb' : '#f9fafb')
                      .borderRadius(6)
                      .onClick(() => {
                        this.selectedHour = hour
                      })
                  }
                  .margin({ bottom: 4 })
                })
              }
              .height(150)
              .width('100%')
            }
            .width('30%')

            // åˆ†é’Ÿé€‰æ‹©
            Column() {
              Text('åˆ†é’Ÿ')
                .fontSize(14)
                .fontColor('#6b7280')
                .margin({ bottom: 8 })

              List() {
                ForEach(Array.from({length: 60}, (_, i) => i), (minute: number) => {
                  ListItem() {
                    Text(minute.toString().padStart(2, '0'))
                      .fontSize(16)
                      .fontColor(this.selectedMinute === minute ? '#ffffff' : '#1f2937')
                      .fontWeight(this.selectedMinute === minute ? FontWeight.Bold : FontWeight.Normal)
                      .width(40)
                      .height(32)
                      .textAlign(TextAlign.Center)
                      .backgroundColor(this.selectedMinute === minute ? '#2563eb' : '#f9fafb')
                      .borderRadius(6)
                      .onClick(() => {
                        this.selectedMinute = minute
                      })
                  }
                  .margin({ bottom: 4 })
                })
              }
              .height(150)
              .width('100%')
            }
            .width('30%')

            // AM/PM é€‰æ‹©
            Column() {
              Text('ä¸Š/ä¸‹åˆ')
                .fontSize(14)
                .fontColor('#6b7280')
                .margin({ bottom: 8 })

              Column() {
                ForEach(['AM', 'PM'], (period: string) => {
                  Text(period === 'AM' ? 'ä¸Šåˆ' : 'ä¸‹åˆ')
                    .fontSize(16)
                    .fontColor(this.selectedAmPm === period ? '#ffffff' : '#1f2937')
                    .fontWeight(this.selectedAmPm === period ? FontWeight.Bold : FontWeight.Normal)
                    .width(50)
                    .height(32)
                    .textAlign(TextAlign.Center)
                    .backgroundColor(this.selectedAmPm === period ? '#2563eb' : '#f9fafb')
                    .borderRadius(6)
                    .margin({ bottom: 4 })
                    .onClick(() => {
                      this.selectedAmPm = period
                    })
                })
              }
            }
            .width('35%')
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceAround)
          .margin({ bottom: 20 })

          // å½“å‰é€‰æ‹©æ˜¾ç¤º
          Text(this.getCurrentTimeDisplay())
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#2563eb')
            .margin({ bottom: 20 })

          Row() {
            Button('å–æ¶ˆ')
              .fontSize(16)
              .fontColor('#6b7280')
              .backgroundColor('#f3f4f6')
              .width('40%')
              .onClick(() => {
                console.log('å–æ¶ˆé€‰æ‹©æ—¶é—´')
                this.showTimePicker = false
              })

            Button('ç¡®å®š')
              .fontSize(16)
              .fontColor('#ffffff')
              .backgroundColor('#2563eb')
              .width('40%')
              .onClick(() => {
                console.log('ç¡®å®šé€‰æ‹©æ—¶é—´ï¼Œè®¾ç½®æé†’')
                this.showTimePicker = false
                this.setReminderTime()
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceAround)
          .margin({ top: 24 })
        }
        .width('85%')
        .padding(20)
        .backgroundColor('#ffffff')
        .borderRadius(12)
        .position({ x: '7.5%', y: '25%' })
      }
    }
    .width('100%')
    .height('100%')
  }
}