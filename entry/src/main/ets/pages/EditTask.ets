// pages/EditTask.ets
import router from '@ohos.router'
import preferences from '@ohos.data.preferences'

// ä»»åŠ¡æ•°æ®æŽ¥å£
interface TaskItem {
  id: number
  title: string
  content: string
  completed: boolean
  createdAt: string
  reminderTime?: string
}

@Entry
@Component
struct EditTaskPage {
  @State taskId: number = 0
  @State title: string = ''
  @State content: string = ''
  @State reminderTime: string = ''
  @State completed: boolean = false
  @State createdAt: string = ''
  @State showDatePicker: boolean = false
  @State showTimePicker: boolean = false
  @State showDeleteDialog: boolean = false
  @State selectedDate: Date = new Date()
  @State selectedTime: Date = new Date()
  @State isLoading: boolean = false
  @State taskNotFound: boolean = false

  // é¡µé¢æ˜¾ç¤ºæ—¶
  aboutToAppear() {
    this.loadTaskData()
  }

  // åŠ è½½ä»»åŠ¡æ•°æ®
  async loadTaskData() {
    try {
      const params = router.getParams() as { taskId: number }
      if (!params || !params.taskId) {
        this.taskNotFound = true
        return
      }

      this.taskId = params.taskId

      // ä»Žæœ¬åœ°å­˜å‚¨è¯»å–ä»»åŠ¡æ•°æ®
      const context = getContext(this)
      const dataPreferences = await preferences.getPreferences(context, 'todoApp')
      const tasksData = await dataPreferences.get('tasks', '[]')

      let tasks: TaskItem[] = []
      if (typeof tasksData === 'string') {
        tasks = JSON.parse(tasksData)
      }

      // æŸ¥æ‰¾å¯¹åº”çš„ä»»åŠ¡
      const task = tasks.find(t => t.id === this.taskId)
      if (!task) {
        this.taskNotFound = true
        return
      }

      // å¡«å……è¡¨å•æ•°æ®
      this.title = task.title
      this.content = task.content
      this.completed = task.completed
      this.createdAt = task.createdAt
      this.reminderTime = task.reminderTime || ''

      // è®¾ç½®æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨çš„åˆå§‹å€¼
      if (this.reminderTime) {
        const reminderDate = new Date(this.reminderTime)
        this.selectedDate = reminderDate
        this.selectedTime = reminderDate
      }
    } catch (error) {
      console.error('åŠ è½½ä»»åŠ¡æ•°æ®å¤±è´¥:', error)
      this.taskNotFound = true
    }
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´æ˜¾ç¤º
  formatDateTime(date: Date): string {
    const year = date.getFullYear()
    const month = (date.getMonth() + 1).toString().padStart(2, '0')
    const day = date.getDate().toString().padStart(2, '0')
    const hours = date.getHours().toString().padStart(2, '0')
    const minutes = date.getMinutes().toString().padStart(2, '0')

    return `${year}-${month}-${day} ${hours}:${minutes}`
  }

  // è®¾ç½®æé†’æ—¶é—´
  setReminderTime() {
    const combinedDateTime = new Date(
      this.selectedDate.getFullYear(),
      this.selectedDate.getMonth(),
      this.selectedDate.getDate(),
      this.selectedTime.getHours(),
      this.selectedTime.getMinutes()
    )
    this.reminderTime = this.formatDateTime(combinedDateTime)
  }

  // æ¸…é™¤æé†’æ—¶é—´
  clearReminderTime() {
    this.reminderTime = ''
  }

  // ä¿å­˜ä»»åŠ¡ä¿®æ”¹
  async saveTask() {
    // éªŒè¯è¾“å…¥
    if (!this.title.trim()) {
      return
    }

    this.isLoading = true

    try {
      // ä»Žæœ¬åœ°å­˜å‚¨è¯»å–çŽ°æœ‰ä»»åŠ¡
      const context = getContext(this)
      const dataPreferences = await preferences.getPreferences(context, 'todoApp')
      const tasksData = await dataPreferences.get('tasks', '[]')

      let tasks: TaskItem[] = []
      if (typeof tasksData === 'string') {
        tasks = JSON.parse(tasksData)
      }

      // æŸ¥æ‰¾å¹¶æ›´æ–°ä»»åŠ¡
      const taskIndex = tasks.findIndex(t => t.id === this.taskId)
      if (taskIndex !== -1) {
        tasks[taskIndex] = {
          ...tasks[taskIndex],
          title: this.title.trim(),
          content: this.content.trim(),
          reminderTime: this.reminderTime || undefined
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        await dataPreferences.put('tasks', JSON.stringify(tasks))
        await dataPreferences.flush()

        // è¿”å›žé¦–é¡µ
        router.back()
      }
    } catch (error) {
      console.error('ä¿å­˜ä»»åŠ¡å¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  // åˆ é™¤ä»»åŠ¡
  async deleteTask() {
    this.isLoading = true

    try {
      // ä»Žæœ¬åœ°å­˜å‚¨è¯»å–çŽ°æœ‰ä»»åŠ¡
      const context = getContext(this)
      const dataPreferences = await preferences.getPreferences(context, 'todoApp')
      const tasksData = await dataPreferences.get('tasks', '[]')

      let tasks: TaskItem[] = []
      if (typeof tasksData === 'string') {
        tasks = JSON.parse(tasksData)
      }

      // åˆ é™¤ä»»åŠ¡
      tasks = tasks.filter(t => t.id !== this.taskId)

      // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      await dataPreferences.put('tasks', JSON.stringify(tasks))
      await dataPreferences.flush()

      // è¿”å›žé¦–é¡µ
      router.back()
    } catch (error) {
      console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  // å–æ¶ˆæ“ä½œ
  cancelEdit() {
    router.back()
  }

  // æ ¼å¼åŒ–åˆ›å»ºæ—¶é—´æ˜¾ç¤º
  formatCreatedTime(): string {
    if (!this.createdAt) return ''

    const date = new Date(this.createdAt)
    const now = new Date()
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate())
    const taskDate = new Date(date.getFullYear(), date.getMonth(), date.getDate())

    const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`

    if (taskDate.getTime() === today.getTime()) {
      return `ä»Šå¤© ${timeStr} åˆ›å»º`
    } else if (taskDate.getTime() === today.getTime() - 24 * 60 * 60 * 1000) {
      return `æ˜¨å¤© ${timeStr} åˆ›å»º`
    } else {
      return `${date.getMonth() + 1}/${date.getDate()} ${timeStr} åˆ›å»º`
    }
  }

  build() {
    Stack() {
      if (this.taskNotFound) {
        // ä»»åŠ¡æœªæ‰¾åˆ°é¡µé¢
        Column() {
          Text('ðŸ˜•')
            .fontSize(48)
            .margin({ bottom: 16 })

          Text('ä»»åŠ¡ä¸å­˜åœ¨')
            .fontSize(18)
            .fontColor('#6b7280')
            .margin({ bottom: 8 })

          Text('è¯¥ä»»åŠ¡å¯èƒ½å·²è¢«åˆ é™¤')
            .fontSize(14)
            .fontColor('#9ca3af')
            .margin({ bottom: 24 })

          Button('è¿”å›ž')
            .fontSize(16)
            .fontColor('#ffffff')
            .backgroundColor('#2563eb')
            .width(120)
            .onClick(() => {
              router.back()
            })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#f9fafb')
      } else {
        // ä¸»ç•Œé¢
        Column() {
          // é¡¶éƒ¨å¯¼èˆªæ 
          Row() {
            Text('å–æ¶ˆ')
              .fontSize(16)
              .fontColor('#2563eb')
              .onClick(() => {
                this.cancelEdit()
              })

            Blank()

            Text('ç¼–è¾‘ä»»åŠ¡')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#1f2937')

            Blank()

            Text(this.isLoading ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜')
              .fontSize(16)
              .fontColor(this.title.trim() ? '#2563eb' : '#9ca3af')
              .onClick(() => {
                if (!this.isLoading && this.title.trim()) {
                  this.saveTask()
                }
              })
          }
          .width('100%')
          .height(56)
          .padding({ left: 16, right: 16 })
          .backgroundColor('#ffffff')
          .border({ width: { bottom: 1 }, color: '#e5e7eb' })

          // ä¸»è¦å†…å®¹åŒºåŸŸ
          Scroll() {
            Column() {
              // ä»»åŠ¡çŠ¶æ€å’Œåˆ›å»ºæ—¶é—´
              Row() {
                Row() {
                  Text(this.completed ? 'âœ…' : 'â³')
                    .fontSize(16)
                    .margin({ right: 8 })

                  Text(this.completed ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­')
                    .fontSize(14)
                    .fontColor(this.completed ? '#16a34a' : '#ea580c')
                    .fontWeight(FontWeight.Medium)
                }

                Blank()

                Text(this.formatCreatedTime())
                  .fontSize(12)
                  .fontColor('#9ca3af')
              }
              .width('100%')
              .margin({ bottom: 24 })

              // ä»»åŠ¡æ ‡é¢˜è¾“å…¥
              Column() {
                Text('ä»»åŠ¡æ ‡é¢˜ *')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#374151')
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })

                TextInput({ text: this.title, placeholder: 'è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜' })
                  .fontSize(16)
                  .fontColor('#1f2937')
                  .backgroundColor('#f9fafb')
                  .border({ width: 1, color: '#d1d5db', radius: 8 })
                  .height(48)
                  .onChange((value: string) => {
                    this.title = value
                  })
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
              .margin({ bottom: 24 })

              // ä»»åŠ¡å†…å®¹è¾“å…¥
              Column() {
                Text('ä»»åŠ¡å†…å®¹')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#374151')
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })

                TextArea({ text: this.content, placeholder: 'è¯·è¾“å…¥ä»»åŠ¡çš„è¯¦ç»†æè¿°...' })
                  .fontSize(16)
                  .fontColor('#1f2937')
                  .backgroundColor('#f9fafb')
                  .border({ width: 1, color: '#d1d5db', radius: 8 })
                  .height(120)
                  .onChange((value: string) => {
                    this.content = value
                  })
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
              .margin({ bottom: 24 })

              // æé†’æ—¶é—´è®¾ç½®
              Column() {
                Row() {
                  Text('æé†’æ—¶é—´')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#374151')

                  Blank()

                  if (this.reminderTime) {
                    Text('æ¸…é™¤')
                      .fontSize(14)
                      .fontColor('#ef4444')
                      .onClick(() => {
                        this.clearReminderTime()
                      })
                  }
                }
                .width('100%')
                .margin({ bottom: 12 })

                // æé†’æ—¶é—´æ˜¾ç¤º/è®¾ç½®åŒºåŸŸ
                if (this.reminderTime) {
                  // å·²è®¾ç½®æé†’æ—¶é—´
                  Row() {
                    Text('ðŸ“…')
                      .fontSize(20)
                      .margin({ right: 12 })

                    Column() {
                      Text(this.reminderTime)
                        .fontSize(16)
                        .fontColor('#1f2937')
                        .fontWeight(FontWeight.Medium)
                      Text('ç‚¹å‡»ä¿®æ”¹æé†’æ—¶é—´')
                        .fontSize(12)
                        .fontColor('#6b7280')
                        .margin({ top: 2 })
                    }
                    .alignItems(HorizontalAlign.Start)
                    .layoutWeight(1)

                    Text('>')
                      .fontSize(16)
                      .fontColor('#9ca3af')
                  }
                  .width('100%')
                  .padding(16)
                  .backgroundColor('#f0f9ff')
                  .borderRadius(8)
                  .border({ width: 1, color: '#bae6fd' })
                  .onClick(() => {
                    this.showDatePicker = true
                  })
                } else {
                  // æœªè®¾ç½®æé†’æ—¶é—´
                  Row() {
                    Text('â°')
                      .fontSize(18)
                      .margin({ right: 12 })

                    Text('è®¾ç½®æé†’æ—¶é—´')
                      .fontSize(16)
                      .fontColor('#6b7280')
                      .layoutWeight(1)

                    Text('+')
                      .fontSize(20)
                      .fontColor('#2563eb')
                  }
                  .width('100%')
                  .height(56)
                  .padding({ left: 16, right: 16 })
                  .backgroundColor('#ffffff')
                  .borderRadius(8)
                  .border({ width: 1, color: '#d1d5db', style: BorderStyle.Dashed })
                  .onClick(() => {
                    this.showDatePicker = true
                  })
                }
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
              .margin({ bottom: 32 })

              // åˆ é™¤ä»»åŠ¡æŒ‰é’®
              Row() {
                Text('ðŸ—‘')
                  .fontSize(18)
                  .margin({ right: 8 })

                Text('åˆ é™¤ä»»åŠ¡')
                  .fontSize(16)
                  .fontColor('#ef4444')
                  .fontWeight(FontWeight.Medium)
              }
              .width('100%')
              .height(56)
              .padding({ left: 16, right: 16 })
              .backgroundColor('#fef2f2')
              .borderRadius(8)
              .border({ width: 1, color: '#fecaca' })
              .justifyContent(FlexAlign.Center)
              .onClick(() => {
                this.showDeleteDialog = true
              })
              .margin({ bottom: 16 })

              // æç¤ºä¿¡æ¯
              Text('* ä»»åŠ¡æ ‡é¢˜ä¸ºå¿…å¡«é¡¹')
                .fontSize(12)
                .fontColor('#9ca3af')
                .alignSelf(ItemAlign.Start)
            }
            .width('100%')
            .padding(16)
          }
          .layoutWeight(1)
          .backgroundColor('#ffffff')
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#f9fafb')
      }

      // åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
      if (this.showDeleteDialog) {
        Column() {
          Column() {
            // é®ç½©å±‚
          }
          .width('100%')
          .height('100%')
          .backgroundColor('#00000080')
          .onClick(() => {
            this.showDeleteDialog = false
          })

          Column() {
            Text('ç¡®è®¤åˆ é™¤')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .margin({ bottom: 16 })

            Text('åˆ é™¤åŽæ— æ³•æ¢å¤ï¼Œç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')
              .fontSize(14)
              .fontColor('#6b7280')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 24 })

            Row() {
              Button('å–æ¶ˆ')
                .fontSize(16)
                .fontColor('#6b7280')
                .backgroundColor('#f3f4f6')
                .width('45%')
                .onClick(() => {
                  this.showDeleteDialog = false
                })

              Button(this.isLoading ? 'åˆ é™¤ä¸­...' : 'åˆ é™¤')
                .fontSize(16)
                .fontColor('#ffffff')
                .backgroundColor('#ef4444')
                .width('45%')
                .onClick(() => {
                  if (!this.isLoading) {
                    this.showDeleteDialog = false
                    this.deleteTask()
                  }
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
          }
          .width('85%')
          .padding(24)
          .backgroundColor('#ffffff')
          .borderRadius(12)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      }

      // æ—¥æœŸé€‰æ‹©å™¨
      if (this.showDatePicker) {
        Column() {
          Column() {
            // é®ç½©å±‚
          }
          .width('100%')
          .height('100%')
          .backgroundColor('#00000080')
          .onClick(() => {
            this.showDatePicker = false
          })

          Column() {
            Text('é€‰æ‹©æ—¥æœŸ')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .margin({ bottom: 16 })

            DatePicker({
              start: new Date(),
              end: new Date(2030, 11, 31),
              selected: this.selectedDate
            })
              .onChange((value: DatePickerResult) => {
                this.selectedDate = new Date(value.year, value.month, value.day)
              })

            Row() {
              Button('å–æ¶ˆ')
                .fontSize(16)
                .fontColor('#6b7280')
                .backgroundColor('#f3f4f6')
                .width('45%')
                .onClick(() => {
                  this.showDatePicker = false
                })

              Button('ç¡®å®š')
                .fontSize(16)
                .fontColor('#ffffff')
                .backgroundColor('#2563eb')
                .width('45%')
                .onClick(() => {
                  this.showDatePicker = false
                  this.showTimePicker = true
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
            .margin({ top: 24 })
          }
          .width('90%')
          .padding(24)
          .backgroundColor('#ffffff')
          .borderRadius(12)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      }

      // æ—¶é—´é€‰æ‹©å™¨
      if (this.showTimePicker) {
        Column() {
          Column() {
            // é®ç½©å±‚
          }
          .width('100%')
          .height('100%')
          .backgroundColor('#00000080')
          .onClick(() => {
            this.showTimePicker = false
          })

          Column() {
            Text('é€‰æ‹©æ—¶é—´')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .margin({ bottom: 16 })

            TimePicker({
              selected: this.selectedTime
            })
              .onChange((value: TimePickerResult) => {
                const newTime = new Date()
                newTime.setHours(value.hour, value.minute)
                this.selectedTime = newTime
              })

            Row() {
              Button('å–æ¶ˆ')
                .fontSize(16)
                .fontColor('#6b7280')
                .backgroundColor('#f3f4f6')
                .width('45%')
                .onClick(() => {
                  this.showTimePicker = false
                })

              Button('ç¡®å®š')
                .fontSize(16)
                .fontColor('#ffffff')
                .backgroundColor('#2563eb')
                .width('45%')
                .onClick(() => {
                  this.showTimePicker = false
                  this.setReminderTime()
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
            .margin({ top: 24 })
          }
          .width('90%')
          .padding(24)
          .backgroundColor('#ffffff')
          .borderRadius(12)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
  }
}