/**
 * Desined By: Charles Dong
 * Date: 2025/5/26
 * é¸¿è’™åŸç”Ÿåº”ç”¨ï¼Œé¥é¥é¢†å…ˆ
 * */
// pages/Index.ets

import router from '@ohos.router'
import preferences from '@ohos.data.preferences'

// ä»»åŠ¡æ•°æ®æ¥å£
interface TaskItem {
  id: number
  title: string
  content: string
  completed: boolean
  createdAt: string
  reminderTime?: string
}

@Entry
@Component
struct HomePage {
  @State tasks: TaskItem[] = []
  @State totalTasks: number = 0
  @State completedTasks: number = 0
  @State reminderTimer: number = -1

  // ç”Ÿå‘½å‘¨æœŸï¼šé¡µé¢æ˜¾ç¤ºæ—¶
  aboutToAppear() {
    this.loadTasksFromStorage()
    this.startReminderCheck()
  }

  // é¡µé¢æ¶ˆå¤±æ—¶æ¸…ç†å®šæ—¶å™¨
  aboutToDisappear() {
    if (this.reminderTimer !== -1) {
      clearInterval(this.reminderTimer)
    }
  }

  // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä»»åŠ¡æ•°æ®
  async loadTasksFromStorage() {
    try {
      const context = getContext(this)
      const dataPreferences = await preferences.getPreferences(context, 'todoApp')
      const tasksData = await dataPreferences.get('tasks', '[]')

      if (typeof tasksData === 'string') {
        this.tasks = JSON.parse(tasksData)
      }

      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ·»åŠ ç¤ºä¾‹æ•°æ®
      if (this.tasks.length === 0) {
        this.tasks = [
          {
            id: 1,
            title: 'å®Œæˆé¡¹ç›®æŠ¥å‘Š',
            content: 'éœ€è¦æ•´ç†æœ¬æœˆçš„å·¥ä½œæ€»ç»“å’Œä¸‹æœˆè®¡åˆ’',
            completed: false,
            createdAt: '2025-05-25 09:30',
            reminderTime: '2025-05-26 14:00'
          },
          {
            id: 2,
            title: 'è´­ä¹°ç”Ÿæ´»ç”¨å“',
            content: 'ç‰™è†ã€æ´—å‘æ°´ã€é¢åŒ…ã€ç‰›å¥¶',
            completed: true,
            createdAt: '2025-05-24 18:20'
          },
          {
            id: 3,
            title: 'é”»ç‚¼èº«ä½“',
            content: 'è·‘æ­¥30åˆ†é’Ÿ',
            completed: false,
            createdAt: '2025-05-25 07:00',
            reminderTime: '2025-05-25 19:00'
          }
        ]
        await this.saveTasksToStorage()
      }

      this.updateStatistics()
    } catch (error) {
      console.error('åŠ è½½ä»»åŠ¡æ•°æ®å¤±è´¥:', error)
    }
  }

  // ä¿å­˜ä»»åŠ¡æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
  async saveTasksToStorage() {
    try {
      const context = getContext(this)
      const dataPreferences = await preferences.getPreferences(context, 'todoApp')
      await dataPreferences.put('tasks', JSON.stringify(this.tasks))
      await dataPreferences.flush()
    } catch (error) {
      console.error('ä¿å­˜ä»»åŠ¡æ•°æ®å¤±è´¥:', error)
    }
  }

  // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  updateStatistics() {
    this.totalTasks = this.tasks.length
    this.completedTasks = this.tasks.filter(task => task.completed).length
  }

  // åˆ‡æ¢ä»»åŠ¡å®ŒæˆçŠ¶æ€
  async toggleTaskCompletion(taskId: number) {
    const taskIndex = this.tasks.findIndex(task => task.id === taskId)
    if (taskIndex !== -1) {
      this.tasks[taskIndex].completed = !this.tasks[taskIndex].completed
      await this.saveTasksToStorage()
      this.updateStatistics()
    }
  }

  // åˆ é™¤ä»»åŠ¡
  async deleteTask(taskId: number) {
    this.tasks = this.tasks.filter(task => task.id !== taskId)
    await this.saveTasksToStorage()
    this.updateStatistics()
  }

  // æ£€æŸ¥æé†’æ˜¯å¦æ¿€æ´»ï¼ˆæ—¶é—´å·²åˆ°æˆ–å³å°†åˆ°ï¼‰
  isReminderActive(reminderTime: string): boolean {
    if (!reminderTime) return false

    const now = new Date()
    const reminderDate = new Date(reminderTime)
    const timeDiff = reminderDate.getTime() - now.getTime()

    // å¦‚æœæ—¶é—´å·²è¿‡æˆ–åœ¨5åˆ†é’Ÿå†…
    return timeDiff <= 5 * 60 * 1000
  }

  // å¯åŠ¨æé†’æ£€æŸ¥
  startReminderCheck() {
    // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æé†’
    this.reminderTimer = setInterval(() => {
      this.checkReminders()
    }, 60000) // 60ç§’æ£€æŸ¥ä¸€æ¬¡

    // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
    this.checkReminders()
  }

  // æ£€æŸ¥æ‰€æœ‰ä»»åŠ¡çš„æé†’
  checkReminders() {
    const now = new Date()

    this.tasks.forEach(task => {
      if (!task.completed && task.reminderTime) {
        const reminderDate = new Date(task.reminderTime)
        const timeDiff = reminderDate.getTime() - now.getTime()

        // å¦‚æœæé†’æ—¶é—´åˆ°äº†ï¼ˆè¯¯å·®åœ¨1åˆ†é’Ÿå†…ï¼‰
        if (Math.abs(timeDiff) <= 60000) {
          this.showReminder(task)
        }
      }
    })
  }

  // æ˜¾ç¤ºæé†’ï¼ˆç®€å•çš„æ§åˆ¶å°æé†’ï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥ä½¿ç”¨é€šçŸ¥ï¼‰
  showReminder(task: TaskItem) {
    console.log(`â° æé†’ï¼š${task.title}`)
    console.log(`ğŸ“ å†…å®¹ï¼š${task.content}`)

    // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„æé†’é€»è¾‘
    // æ¯”å¦‚ç³»ç»Ÿé€šçŸ¥ã€å¼¹çª—ç­‰
    // ç”±äºé¸¿è’™é€šçŸ¥éœ€è¦æƒé™é…ç½®ï¼Œè¿™é‡Œå…ˆç”¨æ—¥å¿—æé†’
  }

  // è·å–æ’åºåçš„ä»»åŠ¡åˆ—è¡¨ï¼ˆæœªå®Œæˆä¼˜å…ˆï¼‰
  getSortedTasks(): TaskItem[] {
    return this.tasks.sort((a, b) => {
      if (a.completed === b.completed) {
        return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
      }
      return Number(a.completed) - Number(b.completed)
    })
  }

  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  formatTime(timeString: string): string {
    if (!timeString) return ''

    const date = new Date(timeString)
    const now = new Date()
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate())
    const taskDate = new Date(date.getFullYear(), date.getMonth(), date.getDate())

    const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`

    if (taskDate.getTime() === today.getTime()) {
      return `ä»Šå¤© ${timeStr}`
    } else if (taskDate.getTime() === today.getTime() - 24 * 60 * 60 * 1000) {
      return `æ˜¨å¤© ${timeStr}`
    } else {
      return `${date.getMonth() + 1}/${date.getDate()} ${timeStr}`
    }
  }

  // è·³è½¬åˆ°æ·»åŠ ä»»åŠ¡é¡µé¢
  navigateToAddTask() {
    router.pushUrl({
      url: 'pages/AddTask'
    })
  }

  // è·³è½¬åˆ°ç¼–è¾‘ä»»åŠ¡é¡µé¢
  navigateToEditTask(taskId: number) {
    router.pushUrl({
      url: 'pages/EditTask',
      params: { taskId: taskId }
    })
  }

  build() {
    Stack({ alignContent: Alignment.BottomEnd }) {
      Column() {
        // é¡¶éƒ¨ç»Ÿè®¡ä¿¡æ¯åŒºåŸŸ - ç²¾ç¾è®¾è®¡
        Column() {
          // æ¸å˜èƒŒæ™¯å¤´éƒ¨
          Column() {
            Row() {
              Column() {
                Text('âœ¨ æˆ‘çš„å¾…åŠ')
                  .fontSize(28)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#ffffff')

                Text('è®©æ¯ä¸€å¤©éƒ½å……æ»¡æˆå°±æ„Ÿ')
                  .fontSize(14)
                  .fontColor('#e0f2fe')
                  .margin({ top: 4 })
              }
              .alignItems(HorizontalAlign.Start)

              Blank()

              // ä¸ªäººå¤´åƒåŒºåŸŸ
              Row() {
                Text('ğŸ‘¤')
                  .fontSize(24)
              }
              .width(48)
              .height(48)
              .borderRadius(24)
              .backgroundColor('#ffffff20')
              .justifyContent(FlexAlign.Center)
            }
            .width('100%')
            .margin({ bottom: 24 })
            // ç»Ÿè®¡å¡ç‰‡åŒºåŸŸ
            Row() {
              // æ€»ä»»åŠ¡å¡ç‰‡
              Column() {
                Row() {
                  Text('ğŸ“‹')
                    .fontSize(20)
                    .margin({ right: 8 })

                  Column() {
                    Text(this.totalTasks.toString())
                      .fontSize(24)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#ffffff')
                    Text('æ€»ä»»åŠ¡')
                      .fontSize(12)
                      .fontColor('#e0f2fe')
                  }
                  .alignItems(HorizontalAlign.Start)
                }
                .width('100%')
                .justifyContent(FlexAlign.Start)
              }
              .width('30%')
              .height(70)
              .padding(12)
              .backgroundColor('#ffffff20')
              .borderRadius(12)

              // å·²å®Œæˆå¡ç‰‡
              Column() {
                Row() {
                  Text('âœ…')
                    .fontSize(20)
                    .margin({ right: 8 })

                  Column() {
                    Text(this.completedTasks.toString())
                      .fontSize(24)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#ffffff')
                    Text('å·²å®Œæˆ')
                      .fontSize(12)
                      .fontColor('#e0f2fe')
                  }
                  .alignItems(HorizontalAlign.Start)
                }
                .width('100%')
                .justifyContent(FlexAlign.Start)
              }
              .width('30%')
              .height(70)
              .padding(12)
              .backgroundColor('#ffffff20')
              .borderRadius(12)

              // å®Œæˆç‡å¡ç‰‡
              Column() {
                Row() {
                  Text('ğŸ¯')
                    .fontSize(20)
                    .margin({ right: 8 })

                  Column() {
                    Text(`${this.totalTasks > 0 ? Math.round((this.completedTasks / this.totalTasks) * 100) : 0}%`)
                      .fontSize(24)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#ffffff')
                    Text('å®Œæˆç‡')
                      .fontSize(12)
                      .fontColor('#e0f2fe')
                  }
                  .alignItems(HorizontalAlign.Start)
                }
                .width('100%')
                .justifyContent(FlexAlign.Start)
              }
              .width('30%')
              .height(70)
              .padding(12)
              .backgroundColor('#ffffff20')
              .borderRadius(12)
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
          }
          .width('100%')
          .padding(20)
          .linearGradient({
            angle: 135,
            colors: [['#667eea', 0.0], ['#764ba2', 1.0]]
          })
          .borderRadius({ bottomLeft: 24, bottomRight: 24 })
        }

        // ä»»åŠ¡åˆ—è¡¨åŒºåŸŸ
        if (this.tasks.length === 0) {
          // ç²¾ç¾çš„ç©ºçŠ¶æ€
          Column() {
            Text('ğŸ‰')
              .fontSize(64)
              .margin({ bottom: 16 })

            Text('å¤ªæ£’äº†ï¼')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#4f46e5')
              .margin({ bottom: 8 })

            Text('æš‚æ—¶æ²¡æœ‰å¾…åŠä»»åŠ¡')
              .fontSize(16)
              .fontColor('#6b7280')
              .margin({ bottom: 4 })

            Text('ç‚¹å‡»å³ä¸‹è§’çš„æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªä»»åŠ¡å§')
              .fontSize(14)
              .fontColor('#9ca3af')
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        } else {
          // ç²¾ç¾çš„ä»»åŠ¡åˆ—è¡¨
          Column() {
            // åˆ—è¡¨æ ‡é¢˜
            Row() {
              Text('ğŸ“ ä»»åŠ¡æ¸…å•')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#1f2937')

              Blank()

              Text(`${this.totalTasks - this.completedTasks} é¡¹å¾…å®Œæˆ`)
                .fontSize(14)
                .fontColor('#6b7280')
                .padding({ left: 12, right: 12, top: 4, bottom: 4 })
                .backgroundColor('#f3f4f6')
                .borderRadius(12)
            }
            .width('100%')
            .margin({ bottom: 16 })

            List({ space: 16 }) {
              ForEach(this.getSortedTasks(), (task: TaskItem) => {
                ListItem() {
                  Row() {
                    // å®ŒæˆçŠ¶æ€å¤é€‰æ¡† - ç²¾ç¾æ ·å¼
                    Row() {
                      if (task.completed) {
                        Text('âœ“')
                          .fontSize(16)
                          .fontColor('#ffffff')
                          .fontWeight(FontWeight.Bold)
                      }
                    }
                    .width(28)
                    .height(28)
                    .borderRadius(14)
                    .backgroundColor(task.completed ? '#10b981' : '#ffffff')
                    .border({
                      width: 2,
                      color: task.completed ? '#10b981' : '#e5e7eb'
                    })
                    .justifyContent(FlexAlign.Center)
                    .shadow({
                      radius: task.completed ? 8 : 4,
                      color: task.completed ? '#10b98120' : '#00000010',
                      offsetX: 0,
                      offsetY: 2
                    })
                    .onClick(() => {
                      this.toggleTaskCompletion(task.id)
                    })

                    // ä»»åŠ¡å†…å®¹åŒºåŸŸ
                    Column() {
                      Text(task.title)
                        .fontSize(18)
                        .fontWeight(FontWeight.Medium)
                        .fontColor(task.completed ? '#9ca3af' : '#1f2937')
                        .decoration({
                          type: task.completed ? TextDecorationType.LineThrough : TextDecorationType.None
                        })
                        .maxLines(2)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })

                      if (task.content) {
                        Text(task.content)
                          .fontSize(15)
                          .fontColor(task.completed ? '#9ca3af' : '#6b7280')
                          .maxLines(2)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                          .margin({ top: 4 })
                      }

                      // æ—¶é—´ä¿¡æ¯è¡Œ
                      Row() {
                        // åˆ›å»ºæ—¶é—´
                        Row() {
                          Text('ğŸ•')
                            .fontSize(12)
                          Text(`${this.formatTime(task.createdAt)}`)
                            .fontSize(12)
                            .fontColor('#9ca3af')
                            .margin({ left: 4 })
                        }

                        if (task.reminderTime) {
                          Row() {
                            Text('â°')
                              .fontSize(12)
                            Text(`${this.formatTime(task.reminderTime)}`)
                              .fontSize(12)
                              .fontColor(this.isReminderActive(task.reminderTime) ? '#ef4444' : '#9ca3af')
                              .margin({ left: 4 })
                          }
                          .margin({ left: 16 })
                        }
                      }
                      .margin({ top: 8 })
                    }
                    .layoutWeight(1)
                    .margin({ left: 16, right: 16 })
                    .alignItems(HorizontalAlign.Start)
                    .onClick(() => {
                      this.navigateToEditTask(task.id)
                    })

                    // åˆ é™¤æŒ‰é’® - ç²¾ç¾æ ·å¼
                    Row() {
                      Text('ğŸ—‘')
                        .fontSize(16)
                    }
                    .width(36)
                    .height(36)
                    .borderRadius(18)
                    .backgroundColor('#fef2f2')
                    .border({ width: 1, color: '#fecaca' })
                    .justifyContent(FlexAlign.Center)
                    .onClick(() => {
                      this.deleteTask(task.id)
                    })
                  }
                  .width('100%')
                  .padding(20)
                  .backgroundColor(task.completed ? '#f8fafc' : '#ffffff')
                  .borderRadius(16)
                  .border({
                    width: 1,
                    color: task.completed ? '#e2e8f0' : '#f1f5f9'
                  })
                  .shadow({
                    radius: 8,
                    color: '#00000008',
                    offsetX: 0,
                    offsetY: 4
                  })
                }
                .swipeAction({ end: this.deleteButton(task.id) })
              })
            }
            .width('100%')
            .layoutWeight(1)
          }
          .width('100%')
          .layoutWeight(1)
          .padding({ left: 20, right: 20, top: 20, bottom: 100 })
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f8fafc')

      // ç²¾ç¾çš„æµ®åŠ¨æ·»åŠ æŒ‰é’®
      Row() {
        Text('+')
          .fontSize(28)
          .fontColor('#ffffff')
          .fontWeight(FontWeight.Bold)
      }
      .width(64)
      .height(64)
      .borderRadius(32)
      .linearGradient({
        angle: 135,
        colors: [['#667eea', 0.0], ['#764ba2', 1.0]]
      })
      .justifyContent(FlexAlign.Center)
      .margin({ right: 20, bottom: 20 })
      .shadow({
        radius: 16,
        color: '#667eea40',
        offsetX: 0,
        offsetY: 8
      })
      .onClick(() => {
        this.navigateToAddTask()
      })
    }
    .width('100%')
    .height('100%')
  }

  // æ»‘åŠ¨åˆ é™¤æŒ‰é’®
  @Builder deleteButton(taskId: number) {
    Row() {
      Text('åˆ é™¤')
        .fontSize(14)
        .fontColor('#ffffff')
        .fontWeight(FontWeight.Medium)
    }
    .width(80)
    .height('100%')
    .backgroundColor('#ef4444')
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.deleteTask(taskId)
    })
  }
}